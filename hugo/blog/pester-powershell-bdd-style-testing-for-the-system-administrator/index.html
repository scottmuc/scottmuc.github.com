<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Pester - PowerShell BDD Style Testing For The System Administrator</title>
	
	
	<link rel="stylesheet" href="/hugo/css/style.css">
	
</head>
<body>
	<header>
		<h1>
			<a href="https://scottmuc.com/hugo/">More Muc Than You Can Handle</a>
		</h1>
	</header>

	
	<main>
		<article>
			<time>May 11, 2011</time>
			<h1>Pester - PowerShell BDD Style Testing For The System Administrator</h1>
			<div>
				<p>Hi there and welcome to my demo of Pester, a BDD style testing framework for Powershell. The creation of Pester came out of the desire to test some build/deployment infrastructure we were creating for a project. We wrote nearly all the code without tests and it came to bite us in the end. I wanted to find a way ensure these problems didn&rsquo;t happen again as well as provide some code coverage to give new entrants to the codebase some confidence that they won&rsquo;t break everything.</p>
<p>Inside Pester there&rsquo;s already a trivial Calculator example but it&rsquo;s not really the best way to demonstrate the app. Pester itself is tested using Pester. In fact it&rsquo;s being tested by the version of Pester that&rsquo;s under test (although Martin pointed out some uncovered areas). Still, probably not the best way to show how it all works.</p>
<p>What I&rsquo;m going to go through here is the beginning of what could possibly be a real world scenario for a person assigned to write deployment code.</p>
<h2 id="heres-the-story">Here&rsquo;s the story:</h2>
<p>Initech has had issues where their .Net web applications have been deployed on production servers with the debug compilation flag set to true. This has made production support people irritable because they now manually tweak the web.config every single time they do a deploy. Michael Bolton has decided he&rsquo;s going to automate this step but wants to right it test first. He doesn&rsquo;t want to repeat the debacle of his previous attempt at being clever.</p>
<p>First step is to setup a project. Mike (as he now likes be known as) decides to call his project of tools IDeploy and creates a folder of that name where he does is development.</p>
<p>Setting up Pester is simply a matter of following the instructions at PsGet (author Mike Chaliy has tons of great PowerShell modules)then running Install-Pester. Then running Import-Module Pester anytime you open up a PowerShell session where you want to use Pester. The console should look like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} (new-object Net.WebClient).DownloadString(<span style="color:#e6db74">&#34;http://bit.ly/GetPsGet&#34;</span>) | iex
</span></span><span style="display:flex;"><span>Downloading PsGet from https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/chaliy/psget/raw/master/PsGet/PsGet.psm1
</span></span><span style="display:flex;"><span>PsGet is installed and ready to use
</span></span><span style="display:flex;"><span>USAGE<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    import-module PsGet
</span></span><span style="display:flex;"><span>    install-module https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/chaliy/psurl/raw/master/PsUrl/PsUrl.psm1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">For</span> more details<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>    get-help install-module
</span></span><span style="display:flex;"><span>Or visit http<span style="color:#960050;background-color:#1e0010">:</span>//psget.net
</span></span><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} import-module PsGet
</span></span><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} install-module Pester
</span></span><span style="display:flex;"><span>Module Pester was successfully installed.
</span></span><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} import-module Pester
</span></span><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} Get-Module
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ModuleType Name                      ExportedCommands
</span></span><span style="display:flex;"><span>---------- ----                      ----------------
</span></span><span style="display:flex;"><span>Script     PsGet                     {Get-PsGetModuleInfo, Install-Module}
</span></span><span style="display:flex;"><span>Script     Pester                    {It, Describe, New-Fixture, Invoke-Pester...}</span></span></code></pre></div>
<p>Pester includes a helper function called Create-Fixture. Calling the function with no args looks like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} Create-Fixture
</span></span><span style="display:flex;"><span>invalid usage, please specify (path, name)
</span></span><span style="display:flex;"><span>eg<span style="color:#960050;background-color:#1e0010">:</span> .\Create-Fixture -Path Foo -Name Bar
</span></span><span style="display:flex;"><span>creates .\Foo\Bar.ps1 and .\Foo.Bar.Tests.ps1</span></span></code></pre></div>
<p>Create-Fixture wants to know what the path of your function is going to be and what to call it. I personally like having my tests next to what I’m testing so Create-Fixture sort of enforces this convention. Note that Pester can be used without ever using this function. I just never remember how to create my fixtures so this saves me a bit of copying and pasting.</p>
<p>Armed with a quick way to create fixtures Michael runs his Create-Fixture to scaffold his feature. He decides he wants it to be called Ensure-AspNetDebugIsFalse and places it in the Deploy\Functions directory of his project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} Create-Fixture Deploy\Functions Ensure-AspNetDebugIsFalse
</span></span><span style="display:flex;"><span>Creating =&gt; Deploy\Functions\Ensure-AspNetDebugIsFalse.ps1
</span></span><span style="display:flex;"><span>Creating =&gt; Deploy\Functions\Ensure-AspNetDebugIsFalse.Tests.ps1</span></span></code></pre></div>
<p>Wanting to see some red he runs the tests by running Invoke-Pester which loads all files that match *.Tests.ps1 recursively in the current directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SMUCS-PC {C:\d\IDeploy} Invoke-Pester
</span></span><span style="display:flex;"><span>Executing all tests <span style="color:#66d9ef">in</span> C:\dev\IDeploy\Deploy
</span></span><span style="display:flex;"><span>Describing Ensure-AspNetDebugIsFalse
</span></span><span style="display:flex;"><span>does something useful
</span></span><span style="display:flex;"><span>Tests completed
</span></span><span style="display:flex;"><span>Passed<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span> Failed<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span></span></span></code></pre></div>
<p>As you can see Pester by default makes a failing test. Now it’s time for Michael to update the test to make it more meaningful. Here’s his test file after he’s setup his expectations.</p>
<p>Wow, it failed! Why is that? By default Pester will generate a fixture that is silly and won’t ever pass. So what should we do with this broken function? As it stands now it’s totally empty. Let’s update our specification (aka Test) and do something useful.</p>
<p>So Michael has written a test that didn’t require a lot of code, but is actually doing a few cool things. I’ll try to go line by line and explain what’s going on:</p>
<p>Ensure-AspNetDebugIsFalse.Tests.ps1 contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$pwd = Split-Path -Parent $MyInvocation.MyCommand.Path
</span></span><span style="display:flex;"><span>$sut = (Split-Path -Leaf $MyInvocation.MyCommand.Path).Replace(<span style="color:#e6db74">&#34;.Tests.&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>. <span style="color:#e6db74">&#34;</span>$pwd<span style="color:#e6db74">\</span>$sut<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>. <span style="color:#e6db74">&#34;</span>$pwd<span style="color:#e6db74">\..\..\Pester.1.0.1\tools\Pester.ps1&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Describe <span style="color:#e6db74">&#34;Ensure-AspNetDebugIsFalse&#34;</span> {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    Setup <span style="color:#f92672">-File</span> <span style="color:#e6db74">&#34;inetpub\wwwroot\testsite\web.config&#34;</span> `
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;&lt;configuration&gt;&lt;system.web&gt;&lt;compilation debug=&#39;true&#39; /&gt;&lt;/system.web&gt;&lt;/configuration&gt;&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    It <span style="color:#e6db74">&#34;switches debug attribute to false for a web.config in a given website path&#34;</span> {
</span></span><span style="display:flex;"><span>        Ensure-AspNetDebugIsFalse <span style="color:#e6db74">&#34;</span>$TestDrive<span style="color:#e6db74">\inetpub\wwwroot\testsite&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        [<span style="color:#66d9ef">xml</span>] $xml = Get-Content <span style="color:#e6db74">&#34;</span>$TestDrive<span style="color:#e6db74">\inetpub\wwwroot\testsite\web.config&#34;</span>
</span></span><span style="display:flex;"><span>        $xml.configuration.<span style="color:#e6db74">&#34;system.web&#34;</span>.compilation.debug.should.be(<span style="color:#e6db74">&#34;false&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Ensure-AspNetDebugIsFalse.ps1 contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Ensure-AspNetDebugIsFalse($websitePath) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Here are some details on some of the lines in the test.</p>
<ol>
<li>We obtain the directory of the test script because we need to base all other paths off of it</li>
<li>Here’s how we ensure our code/test conventions. This means that the code in Foo.Tests.ps1 will automatically include Foo.ps1 (the code under test) in line 3</li>
<li>Create-Fixture automagically resolves the Pester path no matter what version of Pester you have. This directory will remain static. I might implement an Upgrade-Fixture script so that as you update your Pester version you can update your tests as well.</li>
<li>Pester has the ability to do filesystem based setups. This line is creating a file in isolation in what Pester calls the $TestDrive. The $TestDrive is disposed of after every Describe context. This allows you to perform filesystem related tasks without having to maintain separate test files. This line has created a file called web.config in the inetpub\wwwroot\testsite path in the $TestDrive and the 2nd argument is the content of that file.</li>
<li>We execute the code we want to test</li>
<li>We assert that the debug attribute has been set to false.</li>
</ol>
<p>Let’s make this bad boy pass! Here’s the function fleshed out and the test passes!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Ensure-AspNetDebugIsFalse($websitePath) {
</span></span><span style="display:flex;"><span>    $webConfigPath = <span style="color:#e6db74">&#34;</span>$websitePath<span style="color:#e6db74">\web.config&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">xml</span>] $webConfig = Get-Content $webConfigPath
</span></span><span style="display:flex;"><span>    $webConfig.configuration.<span style="color:#e6db74">&#34;system.web&#34;</span>.compilation.debug = <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>    $webConfig.Save($webConfigPath)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>and the execution of the test:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>SMUC-PC {C:\d\IDeploy} Invoke-Pester
</span></span><span style="display:flex;"><span>Executing all tests <span style="color:#66d9ef">in</span> C:\dev\IDeploy\Deploy
</span></span><span style="display:flex;"><span>Describing Ensure-AspNetDebugIsFalse
</span></span><span style="display:flex;"><span>switches debug attribute to false <span style="color:#66d9ef">for</span> a web.config <span style="color:#66d9ef">in</span> a given website path
</span></span><span style="display:flex;"><span>Tests completed
</span></span><span style="display:flex;"><span>Passed<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span> Failed<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span></span></span></code></pre></div>
<p>Now Michael has an extra tool at his disposal to call when he’s performing deployments. If only he had taken this approach when he wrote his money transfer code. He wouldn’t have missed all those decimal places!</p>
<p>Hope this helps get you running with Pester. There’s a lot more I would like to add but I’m really only adding stuff as I see the need for it. Pester was driven out by my desire to refactor another Powershell library I wrote called PowerYaml. Take a look at the project page to see how I took the untested code, wrapped tests around it, then refactored.</p>
<p>Feedback is greatly appreciate and I hope this helps your teams make reliable Powershell scripts.</p>

			</div>
			
			<div>
				<ul id="tags">
					
					<li><a href="/tags/pester">pester</a></li>
					
				</ul>
			</div>
			
		</article>
	</main>


	<footer>
		<p>Copyright &copy; 2024 Scott Muc</p>
	</footer>
</body>
</html>
