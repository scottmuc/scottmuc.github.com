<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Testing Powershell Code That Talks to CLR Objects</title>
	
	
	<link rel="stylesheet" href="/hugo/css/style.css">
	
</head>
<body>
	<header>
		<h1>
			<a href="https://scottmuc.com/hugo/">More Muc Than You Can Handle</a>
		</h1>
	</header>

	
	<main>
		<article>
			<time>Jun 5, 2014</time>
			<h1>Testing Powershell Code That Talks to CLR Objects</h1>
			<div>
				<p>Several months ago someone posted an excellent question on the <a href="https://groups.google.com/forum/#!topic/pester/Y8UzSiNlcSE">Pester Group</a> about a certain problem area
in testing PowerShell with <a href="https://github.com/pester/Pester">Pester</a>.  He brings up a relevant example of the difficulties that can occur when writing tests
is done afterwards. It also reveals a missing feature of Pester.</p>
<p>First let me display the code that needed tests:</p>
<p>{% gist e5abe37881628f13cd0a Get-FromSFtp.ps1 %}</p>
<p>Here are a couple reasons why this code is difficult to test:</p>
<ul>
<li>Line 4 returns a CLR object that actually does SFTP</li>
<li>Many parameters are hard coded</li>
</ul>
<h3 id="start-with-integration">Start With Integration</h3>
<p>I started this exercise with the intention of not changing a single character of the code submitted. Here&rsquo;s the story of
how the changes took place (I had a git repo of this, but the files got corrupted). First thing to do was to make the
existing code pass a test as is. In order to do that, I needed an integration environment for it to talk to. So I used
<a href="http://www.vagrantup.com/">Vagrant</a> to spin up a local linux box. I manually configured the box such that the credentials in the code
work. Here&rsquo;s the Vagrantfile</p>
<p>{% gist e5abe37881628f13cd0a Vagrantfile %}</p>
<p>and here&rsquo;s the passing test. I&rsquo;m happy with it because I could change the code or the environment and cause the test to
fail, thus giving me confidence that the test is good enough to tell if me I broke anything.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Describe <span style="color:#e6db74">&#34;Get-FromSFtp Integration&#34;</span> {
</span></span><span style="display:flex;"><span>    It <span style="color:#e6db74">&#34;returns the 2 default dir entries&#34;</span> {
</span></span><span style="display:flex;"><span>        Get-FromSFtp | ForEach-Object { $_.Name } | Should Be <span style="color:#e6db74">&#34;.&#34;</span>, <span style="color:#e6db74">&#34;..&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Happy that I have a feedback loop going now, I begin to start testing the code in isolation. I start by writing the
contexts and specifications:</p>
<h3 id="follow-up-with-isolated-tests">Follow Up With Isolated Tests</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Describe <span style="color:#e6db74">&#34;Get-FromSFtp&#34;</span> {
</span></span><span style="display:flex;"><span>    Context <span style="color:#e6db74">&#34;when connected&#34;</span> {
</span></span><span style="display:flex;"><span>        It <span style="color:#e6db74">&#34;attempts to connect to an sftp server&#34;</span> { }
</span></span><span style="display:flex;"><span>        It <span style="color:#e6db74">&#34;changes to the directory /test&#34;</span> { }
</span></span><span style="display:flex;"><span>        It <span style="color:#e6db74">&#34;gets the contents listing of the directory&#34;</span> { }
</span></span><span style="display:flex;"><span>        It <span style="color:#e6db74">&#34;disconnects from the sftp server&#34;</span> { }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Context <span style="color:#e6db74">&#34;when not connected&#34;</span> {
</span></span><span style="display:flex;"><span>        It <span style="color:#e6db74">&#34;returns 0 files&#34;</span> { }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Context <span style="color:#e6db74">&#34;when an error happens&#34;</span> {
</span></span><span style="display:flex;"><span>        It <span style="color:#e6db74">&#34;prints out the error to the user&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I was stumped for a bit because I realized Pester didn&rsquo;t have the power necessary to do this easily. It didn&rsquo;t mean it
couldn&rsquo;t be tested though. The Mocking functionality came to the rescue as I was able to mock <code>New-Object</code> and decouple
my tests from the <code>Renci.SshNet</code> library. The hard part was hand-rolling the mock object to be used in the tests.</p>
<p>One by one, I made each spec pass. The beginning of each <code>Context</code> was the setup, and each <code>It</code> asserted something from
after that setup and action had been taken. The nice thing that resulted was I could break a specific piece of the
production code, and the specific test would tell me that it&rsquo;s broken at that place (eg: change the directory the
production code goes to).</p>
<p>Here&rsquo;s the complete test file for the code:</p>
<p>{% gist e5abe37881628f13cd0a Get-FromSFtp.Tests.ps1 %}</p>
<h3 id="summary">Summary</h3>
<p>I can&rsquo;t say this is the best test code out there. I think testing PowerShell is in a different place than testing C# or
other OO languages. It seems like the best you can do is test the function logic and test the composition of it all in
an integrated way. The first refactoring change I would likely do to this function is make the connection a parameter.
That way I wouldn&rsquo;t need to mock <code>New-Object</code>, but passing a mock object is still an issue. Perhaps Pester needs a mock
object builder of some kind, though writing mocks by hand wasn&rsquo;t too difficult either. It&rsquo;s something I would expect a
testing framework to be able to do for me though.</p>

			</div>
			
			<div>
				<ul id="tags">
					
					<li><a href="/tags/pester">pester</a></li>
					
				</ul>
			</div>
			
		</article>
	</main>


	<footer>
		<p>Copyright &copy; 2024 Scott Muc</p>
	</footer>
</body>
</html>
