
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Testing Powershell Code That Talks to CLR Objects - More Muc Than You Can Handle</title>
  <meta name="author" content="Scott Muc">

  
  <meta name="description" content="Several months ago someone posted an excellent question on the Pester Group about a certain problem area
in testing PowerShell with Pester. He brings &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://scottmuc.com/testing-powershell-code-that-talks-to-clr-objects">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.scottmuc.com/scottmucblog" rel="alternate" title="More Muc Than You Can Handle" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud">
<link rel="openid2.local_id" href="https://profiles.google.com/scott.muc">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4298809-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">More Muc Than You Can Handle</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.scottmuc.com/scottmucblog" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="https://twitter.com/scottmuc/">Twitter</a></li>
  <li><a href="https://github.com/scottmuc/">Github</a></li>
  <li><a href="http://scottmuclearnstodraw.tumblr.com/">Drawings</a></li>
  <li><a href="https://about.me/scottmuc/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Testing Powershell Code That Talks to CLR Objects</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-06T03:39:41+03:00" pubdate data-updated="true">Jun 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Several months ago someone posted an excellent question on the <a href="https://groups.google.com/forum/#!topic/pester/Y8UzSiNlcSE">Pester Group</a> about a certain problem area
in testing PowerShell with <a href="https://github.com/pester/Pester">Pester</a>.  He brings up a relevant example of the difficulties that can occur when writing tests
is done afterwards. It also reveals a missing feature of Pester.</p>

<p>First let me display the code that needed tests:</p>

<div><script src='https://gist.github.com/e5abe37881628f13cd0a.js?file=Get-FromSFtp.ps1'></script>
<noscript><pre><code>Add-Type -Path (Join-Path -Path $psScriptRoot &quot;Renci.SshNet.dll&quot;)

function Get-FromSFtp {
    $fileList=$null
    try {
        $sftp=New-Object Renci.SshNet.SftpClient(&quot;127.0.0.1&quot;,&quot;test&quot;,&quot;test&quot;)
        $sftp.Connect()
        if($sftp.IsConnected) {
            $sftp.ChangeDirectory(&quot;/test&quot;)
            $fileList=$sftp.ListDirectory(&quot;.&quot;)
        }
        return $fileList
    } catch [Exception] {
        Write-Host $_.Exception.ToString()
    } finally {
        if(($sftp -ne $null) -and ($sftp.IsConnected)) {
            $sftp.Disconnect()
        }
    }
}
</code></pre></noscript></div>


<p>Here are a couple reasons why this code is difficult to test:</p>

<ul>
<li>Line 4 returns a CLR object that actually does SFTP</li>
<li>Many parameters are hard coded</li>
</ul>


<h3>Start With Integration</h3>

<p>I started this exercise with the intention of not changing a single character of the code submitted. Here&rsquo;s the story of
how the changes took place (I had a git repo of this, but the files got corrupted). First thing to do was to make the
existing code pass a test as is. In order to do that, I needed an integration environment for it to talk to. So I used
<a href="http://www.vagrantup.com/">Vagrant</a> to spin up a local linux box. I manually configured the box such that the credentials in the code
work. Here&rsquo;s the Vagrantfile</p>

<div><script src='https://gist.github.com/e5abe37881628f13cd0a.js?file=Vagrantfile'></script>
<noscript><pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!
VAGRANTFILE_API_VERSION = &quot;2&quot;

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = &quot;precise64&quot;
  config.vm.box_url = &quot;http://files.vagrantup.com/precise64.box&quot;
  config.vm.network &quot;forwarded_port&quot;, guest: 22, host: 22
end
</code></pre></noscript></div>


<p>and here&rsquo;s the passing test. I&rsquo;m happy with it because I could change the code or the environment and cause the test to
fail, thus giving me confidence that the test is good enough to tell if me I broke anything.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">Describe</span> <span class="s2">&quot;Get-FromSFtp Integration&quot;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">It</span> <span class="s2">&quot;returns the 2 default dir entries&quot;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">Get-FromSFtp</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Name</span> <span class="p">}</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">Be</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Happy that I have a feedback loop going now, I begin to start testing the code in isolation. I start by writing the
contexts and specifications:</p>

<h3>Follow Up With Isolated Tests</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">Describe</span> <span class="s2">&quot;Get-FromSFtp&quot;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Context</span> <span class="s2">&quot;when connected&quot;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">It</span> <span class="s2">&quot;attempts to connect to an sftp server&quot;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">It</span> <span class="s2">&quot;changes to the directory /test&quot;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">It</span> <span class="s2">&quot;gets the contents listing of the directory&quot;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">It</span> <span class="s2">&quot;disconnects from the sftp server&quot;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Context</span> <span class="s2">&quot;when not connected&quot;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">It</span> <span class="s2">&quot;returns 0 files&quot;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Context</span> <span class="s2">&quot;when an error happens&quot;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">It</span> <span class="s2">&quot;prints out the error to the user&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was stumped for a bit because I realized Pester didn&rsquo;t have the power necessary to do this easily. It didn&rsquo;t mean it
couldn&rsquo;t be tested though. The Mocking functionality came to the rescue as I was able to mock <code>New-Object</code> and decouple
my tests from the <code>Renci.SshNet</code> library. The hard part was hand-rolling the mock object to be used in the tests.</p>

<p>One by one, I made each spec pass. The beginning of each <code>Context</code> was the setup, and each <code>It</code> asserted something from
after that setup and action had been taken. The nice thing that resulted was I could break a specific piece of the
production code, and the specific test would tell me that it&rsquo;s broken at that place (eg: change the directory the
production code goes to).</p>

<p>Here&rsquo;s the complete test file for the code:</p>

<div><script src='https://gist.github.com/e5abe37881628f13cd0a.js?file=Get-FromSFtp.Tests.ps1'></script>
<noscript><pre><code>$here = Split-Path -Parent $MyInvocation.MyCommand.Path
$sut = (Split-Path -Leaf $MyInvocation.MyCommand.Path).Replace(&quot;.Tests.&quot;, &quot;.&quot;)
. &quot;$here\$sut&quot;

$mockSFtpCode = @&quot;
public class MockSFtp {
    public bool ConnectCalled { get; private set; }
    public bool DisconnectCalled { get; private set; }
    public bool IsConnected { get; set; }
    public string ChangeDirectoryParam { get; private set; }
    public string ListDirectoryParam { get; private set; }

    public void Connect() {
        this.ConnectCalled = true;
    }

    public void Disconnect() {
        this.DisconnectCalled = true;
    }

    public void ChangeDirectory(string directory) {
        this.ChangeDirectoryParam = directory;
    }

    public string[] ListDirectory(string path) {
        this.ListDirectoryParam = path;
        return new string[] { &quot;test1&quot; };
    }
}
&quot;@

$throwingMockSFtpCode = @&quot;
public class ThrowingMockSFtp {
    public void Connect() {
        throw new System.Exception();
    }
}
&quot;@

Add-Type -TypeDefinition $mockSFtpCode
Add-Type -TypeDefinition $throwingMockSFtpCode

Describe &quot;Get-FromSFtp&quot; {
    Context &quot;when connected&quot; {
        $mockSFtp = New-Object MockSFtp
        $mockSFtp.IsConnected = $true
        Mock New-Object -MockWith { $mockSFtp }
        $files = Get-FromSFtp

        It &quot;attempts to connect to an sftp server&quot; {
            $mockSFtp.ConnectCalled | Should Be $true
        }

        It &quot;changes to the directory /test&quot; {
            $mockSFtp.ChangeDirectoryParam | Should Be &#39;/test&#39;
        }

        It &quot;gets the content listing of the directory&quot; {
            $mockSFtp.ListDirectoryParam | Should Be &#39;.&#39;
            $files | Should Be @(&quot;test1&quot;)
        }

        It &quot;disconnects from the sftp server&quot; {
            $mockSFtp.DisconnectCalled | Should Be $true
        }
    }

    Context &quot;when not connected&quot; {
        $mockSFtp = New-Object MockSFtp
        $mockSFtp.IsConnected = $false
        Mock New-Object -MockWith { $mockSFtp }
        $files = Get-FromSFtp

        It &quot;returns 0 files&quot; {
            $files | Should BeNullOrEmpty
        }
    }

    Context &quot;when an exception happens&quot; {
        $mockSFtp = New-Object ThrowingMockSFtp
        Mock New-Object -MockWith { $mockSFtp }

        It &quot;prints out the error to the user&quot; {
            # I do not think this is a good test, but until
            # mocking of Write-Host can be done, this is all
            # that we can really do.
            { Get-FromSFtp } | Should Not Throw
        }
    }
}

Describe &quot;Get-FromSFtp Integration&quot; {
    It &quot;returns the 2 default dir entries&quot; {
        Get-FromSFtp | ForEach-Object { $_.Name } | Should Be &quot;.&quot;, &quot;..&quot;
    }
}
</code></pre></noscript></div>


<h3>Summary</h3>

<p>I can&rsquo;t say this is the best test code out there. I think testing PowerShell is in a different place than testing C# or
other OO languages. It seems like the best you can do is test the function logic and test the composition of it all in
an integrated way. The first refactoring change I would likely do to this function is make the connection a parameter.
That way I wouldn&rsquo;t need to mock <code>New-Object</code>, but passing a mock object is still an issue. Perhaps Pester needs a mock
object builder of some kind, though writing mocks by hand wasn&rsquo;t too difficult either. It&rsquo;s something I would expect a
testing framework to be able to do for me though.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Scott Muc</span></span>

      








  


<time datetime="2014-06-06T03:39:41+03:00" pubdate data-updated="true">Jun 6<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/pester/'>pester</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/two-weeks-living-off-the-clock/" title="Previous Post: Two Weeks Living Off the Clock">&laquo; Two Weeks Living Off the Clock</a>
      
      
        <a class="basic-alignment right" href="/leaving-vancouver-and-north-america/" title="Next Post: Leaving Vancouver and North America">Leaving Vancouver and North America &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Scott Muc -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  












</body>
</html>
